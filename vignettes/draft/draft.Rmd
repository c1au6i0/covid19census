---
title: "covid19census:  U.S. and Italy COVID-19 epidemiolagical data with demographic and health related metrics"
#date: "`r Sys.Date()`"
authors:
  - name: Claudio Zanettini
    email: claudio.zanettini@gmail.com
    address:  Department of Oncology, Johns Hopkins University School of Medicine, Baltimore, MD, USA
  - name: Luigi Marchionni
    email: marchion@jhu.edu
    address: Department of Oncology, Johns Hopkins University School of Medicine, Baltimore, MD, USA
    corresponding_author: yes
  - name: Others to be add
    email: otherst@example.com
    address: Another University

abstract: |
  This is the abstract.

  It consists of two paragraphs.
acknowledgements: |
  *Funding* : L.M. was supported by NIH-NCI grants P30CA006973, U01CA196390, R01CA200859and the Department of  Defense (DoD) office of the Congressionally Directed Medical Research Programs (CDMRP) award W81XWH-16-1-0739.
  
  *Conflict of interest* : none.
keywords:
  - covid19
  - R

#fontsize: 12pt
#spacing: halfline # could also be oneline
#classoptions:
#  - endnotes
bibliography: mybibfile.bib
output: rticles::oup_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # By default, hide code; set to TRUE to see code
knitr::opts_chunk$set(fig.pos = 'p') # Places figures on their own pages
knitr::opts_chunk$set(out.width = '100%', dpi=300) # Figure resolution and size
knitr::opts_chunk$set(fig.env="figure") # Latex figure environment
knitr::opts_knit$set(eval.after = "fig.cap")

library(xtable) # Creates tables that follow OUP guidelines; other options, such as kable, may also be workable
```

# Introduction

In the mist of a virus pandemic, unraveling the constant flow of epidemiological data is of paramount importance, not only to  guide the evaluation and implementation of non-pharmacological interventions (NPI), but also to optimize drug development. 

For example, early analysis and modeling of COVID-19 confirmed cases and deaths was employed to assess the effects of ongoing NPI in China and Europe [@flaxman2020; @prem2020tlph]. Moreover, aggregation of COVID-19 epidemiological data with that regarding i) the seasonality of  other coronoviruses, ii) U.S. clinical care capacity, allowed to make long-term predictions on possible effective containment strategies [@kissler2020s]. 

Similarly, early evidences of the correlation between Bacille Calmette-Gu√©rin vaccination and COVID-19 outcomes, spur several clinical investigations [@miller2020m; @shet2020m];
[WHO](https://www.who.int/news-room/commentaries/detail/bacille-calmette-gu%C3%A9rin-(bcg)-vaccination-and-covid-19)].
However, the implications and validity of that initial observation was curtailed  by subsequent models that took into account additional factors [e.s. age; @fukui2020m]. Overall, these few examples underscore the importance, in general, of sharing data and, in particular, of combining of datasets from different sources, for addressing the challenges of the current pandemic emergency.

The current `R` package provides tools to rapidly extract United States and Italy COVID-19 epidemiological metrics (at county and regional level, respectivelty) from different sources and combine them with other demographic and health related datasets. The goal of the package is to facilitate multifactorial analysis and modeling of COVID-19 data by the scientific community.


#  Alghorithm

A family of `get` functions is employed by the `R` package to extract updated time-series data dynamically from different on-line sources and combine them and return a `dataframe`.

For **U.S** the prefix of the functions to extract data is `getus_`, and it is followed by the specific metric of interest:

  * `getus_covid`: extracts data of COVID-19 from the [New York Time git repository](https://github.com/nytimes/covid-19-data).
  * `getus_dex`: extracts data of DEX, an [activity indexes](https://github.com/COVIDExposureIndices/COVIDExposureIndices) calculated  by  Victor Couture, Jonathan Dingel, Allison Green, Jessie Handbury, and Kevin Williams based on smartphone movement data provided by `PlaceIQ`.
  * `getus_tests`: extract info regarding number of tests performed, their results and hospitalization from the repository of [the Covid Tracking Project](https://covidtracking.com/api}).
  * `getus_all`: executes all the above functions and join the results with other datasets statically contained in the package, and returns a `dataframe` with 304 variables.
  
Data regarding the household composition, population sex and age and poverty levels (2018), were retrieved from the [American Community Survey](https://data.census.gov/cedsci/table?q=United%20States). Medical conditions, tobacco use, cancer and, data relative to the number of medical and emergency visits (2017) of medicare beneficiaries were obtained from the [Mapping Medicare Disparities](https://data.cms.gov/mapping-medicare-disparities). The number of hospital beds per county (2020) was calculated from data of the  [Homeland Infrastructure Foundation](https://hifld-geoplatform.opendata.arcgis.com/datasets/hospitals/data?page=18).

For **Italy**, the prefix of the function is `getit_` followed by `covid` or `all`.

  * `getit_covid`: extracts data of COVID-19 cases, deaths, hospitalizations and tests from the [Protezione Civile]( "https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv").
  * `getit_all`: executes the above function and join the results with other datasets statically contained in the package and returns a `dataframe` with 64 variables.
  
Age and sex of the population (2019),  first aid and medical guard visits (2018), smoking status (2018),  prevalence of chronic conditions (2018), annual-household income (2017), household crowding index (2018) and body-mass index were collect from [ISTAT](http://dati.istat.it/?lang=en). Prevalence of types of cancer patients (2016), influenza-vaccination coverage (2019) and the number of hospital beds per 1000 people (2017) were obtained from [Ministero della Salute](http://www.dati.salute.gov.it/). Data of particulate 2.5 (2017) comes from the [Istituto Superiore Per La protezione Ambientale](https://annuario.isprambiente.it/pon/basic/14).

The package documentation reports and describes each variable (`colnames`) and lists all the data sources of each of the functions. Because of the large amount of variables and in order to facilitate exploration of the documentation, it was deemed more practical to create separate functions with separate documentation for each of the country, instead of creating a single function with an argument relative to the country.

  
#  Implementation and use


```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggrepel)
library(scales)
library(corrplot)
theme_set(theme_bw())
```

The package is current available on [github](https://github.com/c1au6i0/covid19census). The following code launch the functions and assign the returned `dataframes` to different names.


\bigskip


```{r get, results="asis", echo=TRUE}
library(covid19census)
dat_it <- getit_all()
dat_us <- getus_all()

unlist(lapply(list(dat_it, dat_us), class))
```

\bigskip

Information  on the dataframes generated by the two functions are reported in table below [table \ref{tab:tab_dat}].

\bigskip

```{r tab_dat, results="asis", echo=FALSE}
tab1 <- as.data.frame(
  tribble(
    ~ getus_all,
    ~ getit_all,
    "304",
    "64",
    "2790",
    "21",
    "7",
    "4",
    "2020-01-21",
    "2020-02-24"
    
  )
)

rownames(tab1) <-
  c("columns", "counties-regions", "sources", "from")


print(
  xtable(
    tab1,
    caption = "Dataframes retuned by the functions.
    The table reports number of columns, number of unique regions (Italy) and counties (U.S.),
    unique sources of data was scarped and earliest data related to COVID-19 metrics, of the dataframes returned
    by the two functions.
    ",
    label = "tab:tab_dat",
    align = c("c", "c", "c")
  ),
  comment = FALSE
)
```

Therefore, data exploration and modeling of COVID-19 metrics can be conveniently performed on single dataframes that combine heterogeneous datasets from multiple sources.

```{r fig_corr, fig.cap=fig_cap, results="asis", echo=FALSE, fig.height=4, fig.width=4, warning=FALSE, message=FALSE}
fig_cap <- "United States Correlation Matrix. An example of exploratory analysis of data from different sources combined by the function `getus\\_all`. Colours indicates Pearson's correlation between pairs of variables"

dat_us %>%
  filter(date == max(date)) %>%
  # get 65 and over
  mutate(age65_over = rowSums(select(., matches(
    "perc_[6|7|8][0-9]"
  )))) %>%
  mutate(urban = if_else(urban == "Urban", 0, 1)) %>% 
  select(
    "cases",
    "deaths",
    "urban",
    "age65_over",
    "perc_poverty",
    "cancer_all" ,
    "diabetes",
    "asthma",
    "hypertension",
    "tobacco_use",
    "tot_beds"
  ) %>%
  rename(
    "age 65 and over" =  age65_over,
    "in poverty" =  perc_poverty,
    "with cancer" = cancer_all,
    "with diabetes" = diabetes,
    "with asthma" = asthma,
    "with hypertension" = hypertension,
    "using tobacco" = tobacco_use,
    "hospital beds" = tot_beds
    
  ) %>%
  na.omit() %>%
  cor() %>%
  corrplot(method = "color",
           tl.cex  = 0.7,
           tl.col = "black",
           cl.cex = 0.7)

```

For example, in  [figure \ref{fig:fig_corr}] correlation analysis of pair of selected U.S. variables and relative visualization. 


# Discussion

The `R` package `covid19census` does this and that so use it


<!-- rmarkdown::render("/Users/heverz/Documents/R_projects/covid19census/vignettes/draft/draft.Rmd", output_file= "draft.pdf") -->

<!-- An equation with a label for cross-referencing: -->

<!-- \begin{equation}\label{eq:eq1} -->
<!-- \int^{r_2}_0 F(r,\varphi){\rm d}r\,{\rm d}\varphi = [\sigma r_2/(2\mu_0)] -->
<!-- \int^{\infty}_0\exp(-\lambda|z_j-z_i|)\lambda^{-1}J_1 (\lambda r_2)J_0 -->
<!-- (\lambda r_i\,\lambda {\rm d}\lambda) -->
<!-- \end{equation} -->

<!-- This equation can be referenced as follows: Eq. \ref{eq:eq1} -->

<!-- ## A subsection -->

<!-- A numbered list: -->

<!-- 1) First point -->
<!-- 2) Second point -->
<!--     - Subpoint -->

<!-- A bullet list: -->

<!-- * First point -->
<!-- * Second point -->

<!-- # Results -->

<!-- Generate a figure. -->

<!-- ```{r fig1, fig.cap="This is the first figure.",echo=TRUE} -->
<!-- plot(1:10,main="Some data",xlab="Distance (cm)",ylab="Time (hours)") -->
<!-- ``` -->

<!-- You can reference this figure as follows: Fig. \ref{fig:fig1}. -->

<!-- # ```{r fig2, fig.cap="This is the second figure.",echo=TRUE} -->
<!-- # plot(1:5,pch=19,main="Some data",xlab="Distance (cm)",ylab="Time (hours)") -->
<!-- # ``` -->
<!-- #  -->
<!-- # Reference to second figure: Fig. \ref{fig:fig2} -->
<!-- #  -->
<!-- <!-- # Generate a table. --> 

<!-- ```{r tab1, results="asis", echo=TRUE} -->
<!-- df = data.frame(ID=1:3,code=letters[1:3]) -->
<!-- print(xtable(df,caption="This is the table caption",label="tab:tab1"), -->
<!--       comment=FALSE) -->
<!-- <!-- ``` --> 

<!-- You can reference this table as follows: Table \ref{tab:tab1}. -->

<!-- # Discussion -->

<!-- You can cross-reference sections and subsections as follows: Section \ref{materials-and-methods} and Section \ref{a-subsection}. -->

<!-- ***Note:*** the last section in the document will be used as the section title for the bibliography. -->

# References
